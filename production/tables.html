<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Meetkey</title>

    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- iCheck -->
    <link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- Select2 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col menu_fixed">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index.html" class="site_title ">
                <div class="row">
                  <div class="col-xs-3">
                    <img src="images/MeetKey_logo3.png" alt="..." class="" style="max-width: 100%; max-height: 100%">
                  </div>
                  <div class="col-xs-8">
                    <img src="images/MeetKey_text.png" alt="..." style="max-width: 100%; max-height: 100%">
                    <!-- <span>Meetkey</span> -->
                  </div>
                  <div class="col-xs-1">
                  </div>
                </div>
              </a>
            </div>

            <div class="clearfix"></div>

            <!-- menu profile quick info -->
            <div class="profile clearfix">
              <div class="profile_pic">
                <img src="images/img.jpg" alt="..." class="img-circle profile_img">
              </div>
              <div class="profile_info">
                <span>(주)한이음/웹팀</span>
                <h2>황채원</h2>
              </div>
            </div>
            <!-- /menu profile quick info -->

            <br />

            <!-- sidebar menu -->
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <!-- <h3>General</h3> -->
                <ul class="nav side-menu">
                  <li><a href="index.html"><i class="fa fa-home"></i> Dashboard </a>
                  </li>
                  <li><a><i class="fa fa-bar-chart-o"></i> 회의 분석 <span class="fa fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="echarts.html">지난 회의 결과</a></li>
                      <li><a href="projects.html">회의록 리스트</a></li>
                    </ul>
                  </li>
                  <li><a><i class="fa fa-edit"></i> 회의 관리 <span class="fa fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="form.html">회의 만들기</a></li>
                      <li><a href="tables_dynamic.html">회의 예약리스트</a></li>
                      <li><a href="project_detail.html">회의 중(임시)</a></li>
                    </ul>
                  </li>
                  <li><a href="tables.html"><i class="fa fa-group"></i> 친구 관리 </a>
                  </li>
                  <li><a href="calendar.html"><i class="fa fa-calendar"></i> 일정 관리 </a>
                  </li>
                  <li><a href="profile.html"><i class="fa fa-cog"></i> 개인 설정 </a>
                  </li>
                </ul>
              </div>

            </div>
            <!-- /sidebar menu -->

          </div>
        </div>

        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <nav>
              <div class="nav toggle">
                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
              </div>

              <ul class="nav navbar-nav navbar-right">
                <li class="">
                  <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    <img src="images/img.jpg" alt="">황채원
                    <span class=" fa fa-angle-down"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-usermenu pull-right">
                    <li><a href="javascript:;"> Profile</a></li>
                    <li>
                      <a href="javascript:;">
                        <span class="badge bg-red pull-right">50%</span>
                        <span>Settings</span>
                      </a>
                    </li>
                    <li><a href="javascript:;">Help</a></li>
                    <li><a href="login.html"><i class="fa fa-sign-out pull-right"></i> Log Out</a></li>
                  </ul>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h3>친구 관리 </h3>
              </div>

              <div class="title_right">
                <div class="col-md-5 col-sm-5 col-xs-12 form-group pull-right top_search">
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search for...">
                    <span class="input-group-btn">
                      <button class="btn btn-default" type="button">Go!</button>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="clearfix"></div>

            <div class="row">

              <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                  <div class="" role="tabpanel" data-example-id="togglable-tabs">
                    <div class="x_title">
                      <ul id="myTab" class="nav nav-tabs bar_tabs" role="tablist">
                        <li role="presentation" class="active">
                          <a href="#tab_1" id="fav-tab" role="tab" data-toggle="tab" aria-expanded="true">즐겨찾기</a>
                        </li>
                        <li role="presentation">
                          <a href="#tab_2" id="group-tab" role="tab" data-toggle="tab" aria-expanded="flase">그룹</a>
                        </li>
                      </ul>
                      <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                      <div id="myTabContent" class="tab-content">
                        <div role="tabpanel" class="tab-pane fade active in" id="tab_1" aria-labelledby="fav-tab">
                          <table id="Fav" class="table table-hover" cellspacing="0" >
                            <thead>
                              <tr role="row">
                                <th aria-controls="Fav">이름</th>
                                <th aria-controls="Fav">회사</th>
                                <th aria-controls="Fav">부서</th>
                                <th aria-controls="Fav">직책</th>
                                <th style="width: 60px"></th>
                              </tr>
                            </thead>
                          </table>
                          <div class="ln_solid"></div>
                          <div class="text-right">
                            <!-- 친구 추가 버튼 -->
                            <button type="button" class="btn btn-primary" id="inputParticipant" data-toggle="modal" data-target="#addfavoriteModal">친구추가</button>
                          </div>
                        </div>
                        <div role="tabpanel" class="tab-pane fade" id="tab_2" aria-labelledby="group-tab">
                          <table id="group" class="table table-hover" cellspacing="0">
                            <thead>
                              <tr>
                                <th>그룹이름</th>
                                <th>멤버</th>
                                <!-- <th style="width: 60px"></th> 삭제버튼 -->
                              </tr>
                            </thead>
                          </table>
                          <div class="ln_solid"></div>
                          <div  class="text-right">
                            <!-- 그룹 추가 버튼 -->
                            <button type="button" class="btn btn-primary" id="inputParticipant" data-toggle="modal" data-target="#addgroupModal">그룹추가</button>
                          </div>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>




              <div class="clearfix"></div>

            </div>
          </div>
        </div>
        <!-- /page content -->

        <!-- footer content -->
        <footer>
          <div class="pull-right">
            Copyright &copy; 2018 Meetkey. All rights reserved.
          </div>
          <div class="clearfix"></div>
        </footer>
        <!-- /footer content -->
      </div>
    </div>

    <!-- 친구 추가 모달창 -->
    <!-- add favorite Modal -->
    <div id="addfavoriteModal" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">

        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">새로운 친구 찾기</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-12">
                <div class="search input-group" class="dataTables_filter">
                  <input type="text" class="form-control" placeholder="id를 검색해주세요" id="uid" aria-describedby="result">
                  <span class="input-group-btn">
                    <button type="button" class="btn btn-primary" onclick=searchFav()>검색</button>
                  </span>
                </div>
                <div id="resultFav" class="searchResult table-responsive p-0">
                  <table class="table">
                    <tbody>
                      <tr>
                        <th>이름</th>
                        <th>회사</th>
                        <th>부서</th>
                        <th>직책</th>
                      </tr>
                      <tr>
                        <td id="uname"></td>
                        <td id="company"></td>
                        <td id="department"></td>
                        <td id="position"></td>
                      </tr>
                    </tbody>
                  </table>
                  <div class="text-right">
                    <button type="button" id="addFav" class="btn btn-info" data-dismiss="modal">추가하기</button>
                  </div>
                </div>
                <p> </p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- add group Modal -->
    <div id="addgroupModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">

        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">새로운 그룹 추가</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <form action="/add/group" method="post">
              <div class="input-group mb-3">
                <span class="input-group-btn">
                  <div class="btn btn-default">그룹명</div>
                </span>
                <input type="text" class="form-control" placeholder="그룹명을 입력해주세요" name="groupname" id="gname">
              </div>
              <div class="form-group mb-3">
                <select id="sel_fav" class="select2 form-control" multiple="multiple" style="width: 100%">
                </select>
              </div>
              <div class="text-right">
                <button type="submit" onclick="addGroup();" class="btn btn-info" data-dismiss="modal">추가</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Select2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script src="./js/cookie.js"></script>

    <!-- <script src="usefulFunction.js"></script> -->
    <script type="text/javascript">
      $(document).ready(function() {
          $('.select2').select2();
      });
    </script>

    <!-- jquery script -->
    <script type="text/javascript">

      var unum = getCookie('unum')? getCookie('unum'):1;

      $(document).ready(function(){ // 처음 페이지 로드 시,

        $('.select2').select2();

        $('#resultFav').hide(); // 아이디 검색결과 테이블 틀 없애주고
        $('#addFav').hide(); // 추가버튼 없애주고
        $("#sel_fav").select2({
          placeholder: "이름검색하구 선택하슈ㅠ",
          allowClear: true, //선택 해제
        });
        printFavorite(); // 즐겨찾는 계정 리스트 프린트
        printGroup();

      });

      // $('a[data-toggle="tab"]').on( 'shown.bs.tab', function (e) { //탭이 보여지고 난 후
      //       $.fn.dataTable.tables( {visible: true, api: true} ).columns.adjust();
      //   } );

      // 즐겨찾는 계정 전체 검색
      function printFavorite(){

        $("#Fav").find("tr:gt(0)").remove(); // 첫번째행 빼고 다 지우기
        $("#sel_fav").find("option").remove();

        var settings = {
          crossDomain: true,
          url: `https://kz2hltyjb2.execute-api.ap-northeast-2.amazonaws.com/test/add/favorite?unum=${unum}`,
          type: "GET",
          contentType: "application/json",
        }

        // response
        // 검색 성공시: [{unum, uname, company, department, position}]
        // 검색 실패시: {message: ""}
        $.ajax(settings)
          .done(function (response) {
            console.log(response);
            if(response.message){
              alert(response.message);
            } else {
              var favorites = response.data;
              for(var i=0; i<favorites.length; i++){
                // 즐겨찾기를 위해
                var data = `
                <tr>
                  <td>${favorites[i].uname}</td>
                  <td>${favorites[i].company}</td>
                  <td>${favorites[i].department}</td>
                  <td>${favorites[i].position}</td>
                  <td><button type="button" class="btn btn-tool" onclick=delFav(${favorites[i].unum})><i class="fa fa-times"></i></button></td>
                </tr>
                `
                $("#Fav").append(data);

                // 그룹 추가를 위해
                //옵션으로 친구 이름만 띄운다
                // var option = $('<option/>');
                // option.attr({'value': favorites[i].unum).text(favorites[i].uname);
                var data = `<option value=${favorites[i].unum}>${favorites[i].uname}</option>`
                $("#sel_fav").append(data);

              }
            }
          })
          .fail(function() {
            alert('즐겨찾는 계정을 불러오는데 실패했습니다.');
          });
      }

      function printGroup(){

        $("#group").find("tr:gt(0)").remove();

        var settings = {
          crossDomain: true,
          url: `https://kz2hltyjb2.execute-api.ap-northeast-2.amazonaws.com/test/add/group?unum=${unum}`,
          type: "GET",
          contentType: "application/json",
        }

        // response
        // 검색 성공시: {groupname: [{username, comname, department, position}]}
        // 검색 실패시: {message: ""}
        $.ajax(settings).done(function (response) {
          for (var key in response) {
            var group = response[key];
            var member = ""
            for(var i=0; i<group.length; i++){
              var user = group[i].uname+"("+group[i].position+")";
              if(i){ member += ", "+user; }
              else { member += user; }
            }
            var data = `
            <tr data-value="${key}">
              <td>${key}</td>
              <td>${member}</td>
              <td><button type="button" class="btn btn-tool" onclick="delGroup('${key}')"><i class="fa fa-times"></i></button></td>
            </tr>
            `
            $("#group").append(data);
          }
        });
      };
      // 아이디로 계정 검색
      function searchFav(){
        var uid = $('#uid').val();

        var settings = {
          crossDomain: true,
          url: `https://kz2hltyjb2.execute-api.ap-northeast-2.amazonaws.com/test/add/search`,
          type: "POST",
          contentType: "application/json",
          data: `{
            "uid": "${uid}"
          }`
        }

        // response
        // 검색 성공시: {unum, uname, company, department, position}
        // 검색 실패시: {message: ""}
        $.ajax(settings)
          .done(function (response) {
            if(response.message){
              // $("#result").text("결과: "+response.message);
              $("#uname").text("");
              $("#company").text("");
              $("#department").text("");
              $("#position").text("");
              $('#resultFav').hide();
              $('#addFav').hide();
              alert(response.message);
            } else {
              $('#resultFav').show(); //검색결과 까꿍
              $("#uname").text(response.uname);
              $("#company").text(response.company);
              $("#department").text(response.department);
              $("#position").text(response.position);
              // 이미지는 추후에 작업할테니 아무거나 폴더에서 끌어와서 작업바람.
              $('#addFav').removeAttr('onclick'); //원래 있는 onclick 함수 삭제하고
              $('#addFav').attr('onClick', `addFav(${response.unum})`); //검색한 계정의 unum으로 파라미터 수정
              $('#addFav').show(); //추가하기 버튼 까꿍
            }
          })
          .fail(function() {
            alert('검색에 실패했습니다. 다시 시도해주세요.');
          });
      }

      // 즐겨찾는 계정 추가하기
      // 파라미터: 검색시 수정했던 친구의 unum
      function addFav(fnum){

        var settings = {
          crossDomain: true,
          url: `https://kz2hltyjb2.execute-api.ap-northeast-2.amazonaws.com/test/add/favorite`,
          type: "POST",
          contentType: "application/json",
          data: `{
            "unum": "${unum}",
            "fnum": "${fnum}"
          }`
        }

        // response
        // 검색 성공시: {}
        // 검색 실패시: {message: ""}
        $.ajax(settings)
          .done(function (response) {
            if(response.message)
              alert(response.message)
            else {
              printFavorite(); //즐겨찾는 계정 리스트 다시 프린트
            }
          })
          .fail(function() {
            alert('추가에 실패했습니다. 다시 시도해주세요.');
          });

      }


      // 즐겨찾는 계정 삭제
      function delFav(fnum){

        var settings = {
          crossDomain: true,
          url: `https://kz2hltyjb2.execute-api.ap-northeast-2.amazonaws.com/test/add/favorite`,
          type: "DELETE",
          contentType: "application/json",
          data: `{
            "unum": "${unum}",
            "fnum": "${fnum}"
          }`
        }

        // response
        // 검색 성공시: {}
        // 검색 실패시: {message: ""}
        $.ajax(settings)
          .done(function (response) {
            if(response.message){
              alert(response.message);
            } else {
              printFavorite(); //즐겨찾는 계정 리스트 다시 프린트
            }
          })
          .fail(function() {
            alert('즐겨찾는 계정을 불러오는데 실패했습니다.');
          });
      }

      //---------------addGroup----------------
      // addGroup 버튼 클릭 시 sel_fav에서 골랐던 옵션 전달
      // 그룹명 포함 되어있음....☆
      function addGroup(){
        //선택된 옵션이 있을 경우,
        if(!($('#sel_fav option:selected').length&&$('#gname').val())) {
          alert('모든 정보를 입력하세요.');
        } else {
          var selectedFav = []
          $('#sel_fav option:selected').each(function(){
            selectedFav.push($(this).val())
          });
          var gname = $('#gname').val();

          var settings = {
            crossDomain: true,
            url: `https://kz2hltyjb2.execute-api.ap-northeast-2.amazonaws.com/test/add/group`,
            type: "POST",
            contentType: "application/json",
            data: `{
              "unum": "${unum}",
              "gname": "${gname}",
              "member": [${selectedFav}]
            }`
          }

          // response
          // 검색 성공시: {}
          // 검색 실패시: {message: ""}
          $.ajax(settings)
            .done(function (response) {
              if(response.message)
                alert(response.message)
              else {
                printGroup(); //즐겨찾는 계정 리스트 다시 프린트
              }
            })
            .fail(function() {
              alert('추가에 실패했습니다. 다시 시도해주세요.');
            });
        }
      };

      // 즐겨찾는 계정 삭제
      function delGroup(gname){

        var settings = {
          crossDomain: true,
          url: `https://kz2hltyjb2.execute-api.ap-northeast-2.amazonaws.com/test/add/group`,
          type: "DELETE",
          contentType: "application/json",
          data: `{
            "unum": "${unum}",
            "gname": "${gname}"
          }`
        }

        // response
        // 검색 성공시: {}
        // 검색 실패시: {message: ""}
        $.ajax(settings)
          .done(function (response) {
            if(response.message){
              alert(response.message);
            } else {
              printGroup(); //즐겨찾는 계정 리스트 다시 프린트
            }
          })
          .fail(function() {
            alert('그룹을 삭제하는데 실패했습니다.');
          });
      }

    </script>
  </body>
</html>
